# ================================================
# CONFIGURATION .HTACCESS - DÉMÉSUD
# Site: https://www.demesud.com
# Dernière mise à jour: 2026-02-19
# ================================================

# Activer le moteur de réécriture
RewriteEngine On

# ================================================
# REDIRECTIONS HTTPS ET WWW
# ================================================

# Forcer HTTPS (à activer après installation du certificat SSL)
# RewriteCond %{HTTPS} off
# RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

# Forcer WWW (à activer si vous voulez www.demesud.com)
# RewriteCond %{HTTP_HOST} !^www\. [NC]
# RewriteRule ^(.*)$ https://www.%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

# OU Forcer sans WWW (si vous préférez demesud.com)
# RewriteCond %{HTTP_HOST} ^www\.(.+)$ [NC]
# RewriteRule ^(.*)$ https://%1/$1 [R=301,L]

# ================================================
# REDIRECTIONS URLS
# ================================================

# Rediriger la racine vers index.html
DirectoryIndex index.html

# Pas de redirections nécessaires - les URLs sont déjà propres
# garde-meubles.html ✓
# installation-villas.html ✓
# mentions-legales.html ✓
# politique-confidentialite.html ✓

# ================================================
# PAGE D'ERREUR PERSONNALISÉE
# ================================================

ErrorDocument 404 /404.html
ErrorDocument 403 /404.html
ErrorDocument 500 /404.html

# ================================================
# SÉCURITÉ - BLOCAGE FICHIERS SENSIBLES
# ================================================

# Bloquer l'accès aux fichiers de configuration
<FilesMatch "\.(htaccess|htpasswd|ini|log|sh|sql|conf|config|bak|backup|swp|db)$">
    Order Allow,Deny
    Deny from all
</FilesMatch>

# Bloquer l'accès au fichier robots.txt en écriture
<Files robots.txt>
    Order Allow,Deny
    Allow from all
</Files>

# Désactiver la liste des répertoires
Options -Indexes

# Désactiver l'exécution de scripts dans les dossiers uploads
<Directory "/assets">
    Options -ExecCGI
    RemoveHandler .php .phtml .php3
    RemoveType .php .phtml .php3
</Directory>

# ================================================
# COMPRESSION GZIP
# ================================================

<IfModule mod_deflate.c>
    # Compresser les types de fichiers texte
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE text/javascript
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/json
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE font/ttf
    AddOutputFilterByType DEFLATE font/otf
    AddOutputFilterByType DEFLATE image/svg+xml
</IfModule>

# ================================================
# MISE EN CACHE NAVIGATEUR
# ================================================

<IfModule mod_expires.c>
    ExpiresActive On
    
    # Images
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/jpg "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/webp "access plus 1 year"
    ExpiresByType image/svg+xml "access plus 1 year"
    ExpiresByType image/x-icon "access plus 1 year"
    
    # CSS et JavaScript
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    ExpiresByType text/javascript "access plus 1 month"
    
    # Polices
    ExpiresByType font/ttf "access plus 1 year"
    ExpiresByType font/otf "access plus 1 year"
    ExpiresByType font/woff "access plus 1 year"
    ExpiresByType font/woff2 "access plus 1 year"
    ExpiresByType application/font-woff "access plus 1 year"
    
    # HTML (pas de cache pour contenu dynamique)
    ExpiresByType text/html "access plus 0 seconds"
</IfModule>

# Cache-Control headers
<IfModule mod_headers.c>
    # Images et médias
    <FilesMatch "\.(jpg|jpeg|png|gif|webp|svg|ico|pdf)$">
        Header set Cache-Control "max-age=31536000, public"
    </FilesMatch>
    
    # CSS et JS
    <FilesMatch "\.(css|js)$">
        Header set Cache-Control "max-age=2592000, public"
    </FilesMatch>
    
    # HTML
    <FilesMatch "\.(html|htm)$">
        Header set Cache-Control "max-age=0, no-cache, no-store, must-revalidate"
    </FilesMatch>
</IfModule>

# ================================================
# SÉCURITÉ - HEADERS HTTP
# ================================================

<IfModule mod_headers.c>
    # Empêcher le clickjacking (iframe)
    Header always set X-Frame-Options "SAMEORIGIN"
    
    # Activer la protection XSS du navigateur
    Header always set X-XSS-Protection "1; mode=block"
    
    # Empêcher le sniffing MIME
    Header always set X-Content-Type-Options "nosniff"
    
    # Politique de référent (ne pas envoyer le referrer vers sites externes)
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    # Content Security Policy (à adapter selon vos besoins)
    # Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://cdn.emailjs.com; style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; img-src 'self' data: https:; font-src 'self' data: https://cdnjs.cloudflare.com;"
    
    # Permissions Policy (anciennement Feature-Policy)
    Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"
</IfModule>

# ================================================
# PROTECTION HOTLINKING (empêcher le vol d'images)
# ================================================

# RewriteCond %{HTTP_REFERER} !^$
# RewriteCond %{HTTP_REFERER} !^https?://(www\.)?demesud\.com [NC]
# RewriteRule \.(jpg|jpeg|png|gif|webp)$ - [F,L]

# ================================================
# ENCODAGE UTF-8
# ================================================

AddDefaultCharset UTF-8
<IfModule mod_mime.c>
    AddCharset UTF-8 .html .css .js .xml .json .txt
</IfModule>

# ================================================
# DÉSACTIVER SERVER SIGNATURE
# ================================================

ServerSignature Off

# ================================================
# LIMITE UPLOAD (si vous avez un formulaire avec fichiers)
# ================================================

# php_value upload_max_filesize 10M
# php_value post_max_size 10M

# ================================================
# FIN CONFIGURATION
# ================================================